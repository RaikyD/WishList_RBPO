# ADR-003: Rate Limiting для защиты от злоупотреблений

## Status
Accepted

## Context
В приложении Wishlist API необходимо защитить систему от злоупотреблений и DDoS атак. Без ограничений на количество запросов злоумышленники могут перегрузить сервер, что приведёт к недоступности сервиса для легитимных пользователей.

Проблемы:
- Отсутствие защиты от DDoS атак
- Возможность злоупотребления API
- Неравномерное распределение нагрузки
- Отсутствие механизма приоритизации запросов

## Decision
Реализовать rate limiting на уровне middleware с использованием sliding window алгоритма.

### Реализованные компоненты:
1. **RateLimitMiddleware** (`app/middlewares.py`):
   - Ограничение GET запросов по IP адресу
   - Настраиваемый лимит через переменную окружения
   - Sliding window алгоритм (60 секунд)
   - Возврат HTTP 429 при превышении лимита

2. **Конфигурация**:
   - `RATE_LIMIT_PER_MINUTE` - количество запросов в минуту (по умолчанию 60)
   - Отдельная настройка для тестового окружения

3. **Формат ответа при превышении лимита**:
   ```json
   {
     "error": {
       "code": "too_many_requests",
       "message": "rate limit"
     }
   }
   ```

## Alternatives

### Альтернатива 1: Token Bucket алгоритм
**Плюсы:**
- Более плавное ограничение трафика
- Возможность "накопления" разрешений
- Лучше подходит для burst трафика

**Минусы:**
- Более сложная реализация
- Требует дополнительной памяти
- Сложность настройки параметров

### Альтернатива 2: Fixed Window алгоритм
**Плюсы:**
- Простота реализации
- Низкое потребление памяти
- Понятная логика работы

**Минусы:**
- Проблема "thundering herd" в начале окна
- Менее точное ограничение
- Возможность превышения лимита в граничных случаях

### Альтернатива 3: Sliding Window (выбранная)
**Плюсы:**
- Более точное ограничение
- Отсутствие проблем с границами окон
- Хороший баланс между точностью и производительностью

**Минусы:**
- Более высокая сложность реализации
- Требует больше памяти для хранения меток времени

### Альтернатива 4: Внешний сервис (Redis)
**Плюсы:**
- Централизованное управление
- Возможность распределённого rate limiting
- Богатые возможности конфигурации

**Минусы:**
- Дополнительная зависимость
- Сложность развёртывания
- Потенциальная точка отказа

## Consequences

### Security Impact
- **Положительные:**
  - Защита от DDoS атак
  - Предотвращение злоупотреблений API
  - Обеспечение доступности сервиса
  - Возможность выявления подозрительной активности

- **Риски:**
  - **R#5 (Denial of Service)**: Снижение риска через ограничение запросов
  - **R#6 (Resource Exhaustion)**: Предотвращение перегрузки сервера
  - Потенциальная блокировка легитимных пользователей при неправильной настройке

### Меры смягчения:
- Настраиваемые лимиты для разных типов пользователей
- Мониторинг и алертинг при превышении лимитов
- Возможность whitelist для доверенных IP
- Логирование заблокированных запросов

### Связь с NFR и Threat Model
- **NFR-01 (Availability)**: Обеспечение доступности через защиту от перегрузки
- **NFR-04 (Performance)**: Контроль нагрузки на систему
- **R#5**: Denial of Service - снижение риска через rate limiting
- **R#6**: Resource Exhaustion - предотвращение перегрузки ресурсов
- **F#3 (Network)**: Защита сетевого уровня от злоупотреблений

## Rollout Plan

### Критерии приёмки (Definition of Done):
- [x] Rate limiting работает для GET запросов
- [x] Настраиваемые лимиты через переменные окружения
- [x] Корректный HTTP 429 ответ при превышении лимита
- [x] Тесты покрывают все сценарии rate limiting
- [x] Документация по настройке лимитов

### План внедрения:
1. **Этап 1**: Реализация базового rate limiting middleware
2. **Этап 2**: Настройка конфигурации для разных окружений
3. **Этап 3**: Написание тестов для всех сценариев
4. **Этап 4**: Мониторинг и настройка лимитов в продакшене

### Мониторинг:
- Отслеживание количества заблокированных запросов
- Анализ паттернов превышения лимитов
- Мониторинг производительности middleware
- Алертинг при аномальной активности

### Будущие улучшения:
- Различные лимиты для разных типов пользователей
- Интеграция с системой аутентификации
- Более сложные алгоритмы ограничения
- Интеграция с внешними системами мониторинга

## Links
- **NFR-01**: Availability requirements
- **NFR-04**: Performance requirements
- **R#5**: Denial of Service risk
- **R#6**: Resource Exhaustion risk
- **F#3**: Network threat
- **Тест**: `tests/test_rate_limit.py`
- **Код**: `app/middlewares.py`
