# ADR-001: Централизованная обработка ошибок в формате RFC 7807

## Status
Accepted

## Context
В приложении Wishlist API необходимо обеспечить единообразную обработку ошибок для всех эндпоинтов. Текущая реализация использует стандартные HTTP статус-коды, но не предоставляет структурированную информацию об ошибках в формате, понятном клиентам API.

Проблемы:
- Отсутствие единообразного формата ошибок
- Нет возможности отслеживания запросов через correlation_id
- Отсутствие маскирования чувствительной информации в ошибках
- Нет связи с системой мониторинга и логирования

## Decision
Реализовать централизованную обработку ошибок с использованием формата RFC 7807 (Problem Details for HTTP APIs).

### Реализованные компоненты:
1. **Централизованные обработчики ошибок** (`app/errors.py`):
   - `http_exception_handler` - для HTTP исключений
   - `validation_exception_handler` - для ошибок валидации
   - `unhandled_exception_handler` - для необработанных исключений

2. **Формат ответа RFC 7807**:
   ```json
   {
     "error": {
       "code": "error_type",
       "message": "human_readable_message",
       "correlation_id": "request_id"
     }
   }
   ```

3. **Correlation ID** через middleware `RequestIdMiddleware`

## Alternatives

### Альтернатива 1: Стандартные HTTP ошибки
**Плюсы:**
- Простота реализации
- Стандартное поведение

**Минусы:**
- Отсутствие структурированной информации
- Нет возможности отслеживания запросов
- Сложность отладки в продакшене

### Альтернатива 2: Кастомный формат ошибок
**Плюсы:**
- Полный контроль над форматом
- Возможность добавления специфичных полей

**Минусы:**
- Нестандартный подход
- Сложность интеграции с клиентами
- Отсутствие инструментов для работы с форматом

### Альтернатива 3: RFC 7807 (выбранная)
**Плюсы:**
- Стандартизированный формат
- Поддержка correlation_id
- Возможность расширения
- Интеграция с инструментами мониторинга

**Минусы:**
- Дополнительная сложность реализации
- Необходимость обучения команды

## Consequences

### Security Impact
- **Положительные:**
  - Маскирование чувствительной информации в ошибках
  - Возможность отслеживания подозрительной активности через correlation_id
  - Централизованное логирование ошибок для анализа безопасности

- **Риски:**
  - Потенциальная утечка информации через correlation_id (низкий риск)
  - Необходимость правильной настройки логирования

### Связь с NFR и Threat Model
- **NFR-01 (Availability)**: Централизованная обработка ошибок улучшает стабильность системы
- **NFR-02 (Security)**: Маскирование ошибок предотвращает утечку информации
- **R#1 (Information Disclosure)**: Снижение риска через маскирование деталей ошибок
- **F#2 (Data Flow)**: Улучшение трассировки через correlation_id

## Rollout Plan

### Критерии приёмки (Definition of Done):
- [x] Все HTTP ошибки возвращают структурированный формат RFC 7807
- [x] Correlation ID присутствует во всех ответах
- [x] Чувствительная информация маскируется в ошибках
- [x] Тесты покрывают все сценарии ошибок
- [x] Документация обновлена

### План внедрения:
1. **Этап 1**: Реализация базовых обработчиков ошибок
2. **Этап 2**: Добавление correlation_id middleware
3. **Этап 3**: Написание тестов для всех сценариев
4. **Этап 4**: Интеграция с системой мониторинга

### Мониторинг:
- Отслеживание количества ошибок по типам
- Анализ correlation_id для выявления паттернов
- Мониторинг времени обработки ошибок

## Links
- **NFR-01**: Availability requirements
- **NFR-02**: Security requirements
- **R#1**: Information Disclosure risk
- **F#2**: Data Flow threat
- **Тест**: `tests/test_errors.py::test_404_envelope`
- **Код**: `app/errors.py`, `app/middlewares.py`
