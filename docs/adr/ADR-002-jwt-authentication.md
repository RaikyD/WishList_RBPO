# ADR-002: JWT аутентификация для защищённых эндпоинтов

## Status
Accepted

## Context
В приложении Wishlist API необходимо обеспечить безопасный доступ к операциям создания, обновления и удаления желаний. Пользователи должны иметь возможность аутентифицироваться для выполнения привилегированных операций.

Требования:
- Защита эндпоинтов создания, обновления и удаления желаний
- Простая интеграция с клиентскими приложениями
- Возможность масштабирования для множественных пользователей
- Безопасное хранение и передача токенов

## Decision
Реализовать JWT (JSON Web Token) аутентификацию с использованием библиотеки PyJWT.

### Реализованные компоненты:
1. **JWT Security модуль** (`app/security.py`):
   - `require_jwt` dependency для защиты эндпоинтов
   - Валидация JWT токенов с алгоритмом HS256
   - Обработка ошибок аутентификации

2. **Защищённые эндпоинты**:
   - `POST /wishes` - создание желания
   - `PATCH /wishes/{id}` - обновление желания
   - `DELETE /wishes/{id}` - удаление желания
   - `POST /wishes/{id}/purchase` - покупка желания

3. **Формат токена**:
   ```json
   {
     "sub": "user_id",
     "iat": timestamp
   }
   ```

## Alternatives

### Альтернатива 1: Session-based аутентификация
**Плюсы:**
- Простота реализации
- Возможность отзыва сессий
- Стандартный подход для веб-приложений

**Минусы:**
- Требует хранения состояния на сервере
- Сложность масштабирования
- Проблемы с CORS и мобильными приложениями

### Альтернатива 2: API Keys
**Плюсы:**
- Простота использования
- Отсутствие сложной криптографии

**Минусы:**
- Отсутствие информации о пользователе
- Сложность ротации ключей
- Нет временных ограничений

### Альтернатива 3: OAuth 2.0 / OpenID Connect
**Плюсы:**
- Стандартизированный протокол
- Поддержка множественных провайдеров
- Расширенные возможности авторизации

**Минусы:**
- Высокая сложность реализации
- Избыточность для простого API
- Зависимость от внешних сервисов

### Альтернатива 4: JWT (выбранная)
**Плюсы:**
- Stateless архитектура
- Простота масштабирования
- Встроенная информация о пользователе
- Широкое распространение

**Минусы:**
- Сложность отзыва токенов
- Необходимость безопасного хранения секрета
- Потенциальные проблемы с размером токена

## Consequences

### Security Impact
- **Положительные:**
  - Защита привилегированных операций от неавторизованного доступа
  - Возможность отслеживания действий пользователей
  - Отсутствие хранения состояния на сервере

- **Риски:**
  - **R#2 (Authentication Bypass)**: Неправильная валидация токенов
  - **R#3 (Session Management)**: Отсутствие механизма отзыва токенов
  - **R#4 (Secret Management)**: Компрометация JWT секрета

### Меры смягчения:
- Использование сильного секрета (переменная окружения)
- Валидация алгоритма подписи
- Ограничение времени жизни токенов
- Регулярная ротация секрета

### Связь с NFR и Threat Model
- **NFR-02 (Security)**: Обеспечение аутентификации пользователей
- **NFR-03 (Performance)**: Stateless архитектура улучшает производительность
- **R#2**: Authentication Bypass - снижение риска через валидацию токенов
- **R#3**: Session Management - использование JWT вместо сессий
- **F#1 (Authentication)**: Реализация аутентификации через JWT

## Rollout Plan

### Критерии приёмки (Definition of Done):
- [x] Все привилегированные эндпоинты защищены JWT
- [x] Валидация токенов работает корректно
- [x] Обработка ошибок аутентификации
- [x] Тесты покрывают все сценарии аутентификации
- [x] Документация по использованию API

### План внедрения:
1. **Этап 1**: Реализация базовой JWT аутентификации
2. **Этап 2**: Защита всех привилегированных эндпоинтов
3. **Этап 3**: Написание тестов для всех сценариев
4. **Этап 4**: Настройка переменных окружения для продакшена

### Мониторинг:
- Отслеживание неудачных попыток аутентификации
- Мониторинг использования защищённых эндпоинтов
- Анализ паттернов доступа пользователей

## Links
- **NFR-02**: Security requirements
- **NFR-03**: Performance requirements
- **R#2**: Authentication Bypass risk
- **R#3**: Session Management risk
- **F#1**: Authentication threat
- **Тест**: `tests/test_auth.py`
- **Код**: `app/security.py`, `app/adapters/http/wishes_router.py`
