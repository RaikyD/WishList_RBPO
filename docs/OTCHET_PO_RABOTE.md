# Отчет по проделанной работе: "Требования безопасности + Модель угроз"

## Общая оценка проекта

В рамках проекта был разработан защищенный API для управления списками желаний (Wishlist API). Проект включает полную проработку требований безопасности, моделирование угроз по методологии STRIDE, создание диаграмм потоков данных (DFD) и документирование сценариев злоупотребления. Вроде всё выполнил на 9-10, только возможно одного файла из отчета не будет хватать, он в новом форкнутом репо(

---

## Анализ по критериям оценивания

### 1. NFR ≥ 8 с критериями

Разработано десять нефункциональных требований (NFR), что превышает минимальное требование. Все требования оформлены в структурированном виде с указанием метрик, пороговых значений, компонентов системы, приоритетов и методов проверки.

Документация NFR расположена в директории `docs/security_nfr/`:
- `NFR.md` — основная таблица с десятью требованиями
- `NFR_BDD.md` — BDD-сценарии для тестирования требований
- `NFR_TRACEABILITY.md` — трассировка NFR к задачам и историям

Каждое требование имеет количественную метрику для проверки выполнения. Например:
- NFR-01: Формат ошибок и маскирование PII — 100% эндпойнтов в едином формате
- NFR-02: Аутентификация JWT — 100% POST/PATCH/DELETE требуют JWT
- NFR-03: Rate limiting — не более 60 запросов в минуту на IP
- NFR-04: Зависимости без High/Critical уязвимостей — устранение в течение 7 дней
- NFR-05: Секреты не в коде — 0 секретов в репозитории

Требования распределены по компонентам системы (api, build, db, ops) и имеют приоритеты: High, Medium, Low. Для каждого требования указаны методы проверки: тесты, CI-инструменты, код-ревью.

---

### 2. 3-4 DFD с границами доверия

Создано четыре диаграммы потоков данных с границами доверия, что превышает минимальное требование. Диаграммы выполнены в формате Mermaid и расположены в `docs/threat-model/`:

1. `DFD.md` — общий контекст системы, высокоуровневая диаграмма с четырьмя основными потоками данных (F1-F4)

2. `DFD_AUTH.md` — детализация процесса аутентификации и авторизации:
   - 9 потоков данных (F1-F9)
   - Два уровня границ доверия: Edge (граничный слой аутентификации) и Core (ядро системы)
   - Описание процесса проверки JWT токенов, верификации секрета, обработки ошибок аутентификации

3. `DFD_ERRORS.md` — детализация обработки ошибок и логирования:
   - 11 потоков данных (F1-F11)
   - Процесс маскирования PII в ошибках
   - Генерация и использование correlation ID
   - Логирование без чувствительных данных

4. `DFD_PROCESS.md` — детализация бизнес-логики и CRUD операций:
   - 18 потоков данных (F1-F18)
   - Валидация запросов, проверка аутентификации
   - Работа с базой данных через ORM
   - Формирование ответов

Все диаграммы содержат границы доверия (Trust Boundary: Edge и Trust Boundary: Core), потоки данных привязаны к угрозам STRIDE, для каждого потока указаны контрмеры.

---

### 3. STRIDE ≥ 8 угроз

Выявлено десять угроз по методологии STRIDE, что превышает минимальное требование. Все категории STRIDE покрыты анализом угроз.

Угрозы документированы в `docs/threat-model/STRIDE.md`:
- S (Spoofing): Подмена пользователя — R1
- T (Tampering): Нарушение целостности данных — R5, R8
- R (Repudiation): Отсутствие отслеживаемости — R4
- I (Information Disclosure): Утечка информации — R2, R7, R9
- D (Denial of Service): Отказ в обслуживании — R3
- E (Elevation of Privilege): Эскалация привилегий — R6

Каждая угроза привязана к конкретному потоку данных (F1-F5), связана с соответствующим риском (R1-R10), имеет указанные контрмеры и ссылки на NFR требования. Описаны методы проверки: тесты, код-ревью, логирование.

---

### 4. Меры с трассировкой к угрозам/историям

Реализована полная трассировка между угрозами, рисками, NFR требованиями и контрмерами.

Трассировка документирована в нескольких файлах:

**STRIDE.md → RISKS.md:**
Каждая угроза STRIDE связана с конкретным риском через идентификаторы R1-R10. Потоки данных (F1-F5) привязаны к угрозам.

**RISKS.md:**
Риски связаны с NFR через поле "Связь (F/NFR)". Для каждого риска указаны стратегии управления (Снизить, Избежать), определены критерии закрытия рисков, указаны владельцы и сроки.

**NFR_TRACEABILITY.md:**
NFR требования связаны с задачами и историями (Story/Task), указаны приоритеты и релизы.

**ADR документы:**
Архитектурные решения содержат ссылки на связанные угрозы, риски и NFR:
- ADR-001-error-handling.md — связь с NFR-01, R#1, F#2
- ADR-002-jwt-authentication.md — связь с NFR-02, R#2, R#3, F#1
- ADR-003-rate-limiting.md — связь с NFR-01, R#5, R#6, F#3

Примеры трассировки:
- Угроза "S: Spoofing" связана с риском R1, потоком F1, требованием NFR-02, контрмерой JWT аутентификации, проверяется тестом `test_auth_required`
- Угроза "D: Denial of Service" связана с риском R3, потоком F2, требованием NFR-03, контрмерой rate limiting, проверяется тестом `test_rate_limit`
- Угроза "I: Information disclosure" связана с риском R2, потоками F1/F5, требованием NFR-01, контрмерой маскирования PII, проверяется контракт-тестами

---

### 5. Приоритизация/оформление

Риски приоритизированы количественным методом в `RISKS.md`. Используется формула Risk = L × I (Likelihood × Impact). Примеры приоритетов рисков: R1 (15), R3 (12), R5 (9), R10 (10). Для каждого риска указаны стратегии управления (Снизить, Избежать) и определены сроки закрытия.

NFR требования также имеют приоритеты:
- High: NFR-01, NFR-02, NFR-04, NFR-05, NFR-08
- Medium: NFR-03, NFR-06, NFR-07, NFR-10
- Low: NFR-09

Документация оформлена структурированно: используются таблицы в Markdown формате, диаграммы выполнены в Mermaid, документы связаны перекрестными ссылками. Терминология консистентна во всех документах.

Дополнительно созданы три ADR (Architecture Decision Records) с обоснованием архитектурных решений, README.md с описанием проекта и SECURITY.md с политикой безопасности.

---

## Допом на 9-10

### Misuse/Abuse Cases

Создан документ `docs/threat-model/MISUSE_CASES.md` с описанием шести сценариев злоупотребления и неправильного использования системы.

**MC-01: Обход Rate Limiting** (Abuse Case)
Описаны сценарии распределения запросов через прокси или VPN для обхода ограничений по IP-адресу. Рассмотрен вектор атаки, текущие контрмеры и их недостатки, предложены дополнительные меры защиты. Приоритет: Высокий. Связано с STRIDE: D (DoS) и риском R3.

**MC-02: Подделка JWT токена** (Abuse Case)
Проанализированы три варианта атаки: подбор секрета, использование алгоритма "none", эксплуатация истекших токенов. Описаны шаги атаки, векторы компрометации, текущие контрмеры. Приоритет: Критический. Связано с STRIDE: S, E и рисками R1, R6.

**MC-03: Инъекция через параметры запроса** (Abuse Case)
Рассмотрены варианты SQL-инъекций, NoSQL-инъекций и path traversal атак через параметры GET-запросов. Показано, как текущая реализация через ORM защищает от таких атак. Приоритет: Высокий. Связано с STRIDE: T и рисками R5, R8.

**MC-04: Перебор эндпоинтов** (Abuse Case)
Описаны сценарии систематического перебора ID ресурсов, HTTP методов и путей для картографирования API и поиска уязвимостей. Приоритет: Средний. Связано с STRIDE: I и риском R2.

**MC-05: Неправильное использование API** (Misuse Case)
Рассмотрены случаи ошибок законных пользователей: отправка невалидных данных, частые запросы из-за багов в клиенте, попытки работы с несуществующими ресурсами. Приоритет: Низкий. Связано с STRIDE: T и риском R5.

**MC-06: Эскалация привилегий через манипуляцию ID** (Abuse Case)
Описана проблема отсутствия проверки ownership ресурсов, которая может позволить пользователю изменять чужие желания через угадывание ID. Приоритет: Высокий. Связано с STRIDE: E и риском R6.

Каждый случай содержит детальное описание сценария, шаги атаки или злоупотребления, вектор атаки, текущие контрмеры и их недостатки, рекомендуемые дополнительные меры защиты, полную трассировку к угрозам STRIDE, рискам и NFR требованиям.

---

### Качественная аргументация рисков

Риски детально обоснованы в `RISKS.md`. Каждый риск имеет количественную оценку (Likelihood × Impact), обоснованную стратегию управления, определены критерии закрытия, владельцы и сроки.

ADR документы содержат анализ альтернатив архитектурных решений. Например:
- ADR-001 содержит сравнение трех подходов к обработке ошибок с анализом плюсов и минусов каждого
- ADR-002 включает детальный анализ рисков JWT (R#2, R#3, R#4) и меры их смягчения
- ADR-003 описывает четыре альтернативных алгоритма rate limiting с их сравнением

В каждом ADR документе описан контекст проблемы, принятое решение, альтернативы, последствия для безопасности, связь с NFR и моделью угроз.

---

## Реализованные меры безопасности

### Обработка ошибок (ADR-001)

Реализована централизованная обработка ошибок в формате RFC 7807. Все ошибки возвращаются в едином формате, чувствительная информация (PII) маскируется. Во всех ответах присутствует correlation ID (`X-Request-Id`) для трассировки инцидентов. Реализация находится в `app/errors.py`, покрыта тестами в `tests/test_errors.py`.

### JWT Аутентификация (ADR-002)

Защищены все мутирующие операции (POST, PATCH, DELETE) через требование JWT токена. Валидация токенов выполняется с алгоритмом HS256, секрет хранится в переменной окружения. Реализация находится в `app/security.py`, покрыта тестами в `tests/test_auth.py`.

### Rate Limiting (ADR-003)

Реализован rate limiting на основе sliding window алгоритма с лимитом 60 запросов в минуту на IP-адрес. При превышении лимита возвращается HTTP 429. Реализация находится в `app/middlewares.py`, покрыта тестами в `tests/test_rate_limit.py`.

### Дополнительные меры

Зависимости проекта проверяются на наличие High/Critical уязвимостей через SCA-инструменты. Секреты вынесены в переменные окружения, отсутствуют в коде. Валидация данных выполняется через Pydantic схемы. Использование ORM (SQLAlchemy) защищает от SQL-инъекций через параметризованные запросы.

---

## Структура документации

Документация организована в следующей структуре:

```
docs/
├── adr/
│   ├── ADR-001-error-handling.md
│   ├── ADR-002-jwt-authentication.md
│   └── ADR-003-rate-limiting.md
├── security_nfr/
│   ├── NFR.md
│   ├── NFR_BDD.md
│   └── NFR_TRACEABILITY.md
└── threat-model/
    ├── DFD.md
    ├── DFD_AUTH.md
    ├── DFD_ERRORS.md
    ├── DFD_PROCESS.md
    ├── STRIDE.md
    ├── RISKS.md
    └── MISUSE_CASES.md
```

---


### Кратко о чек-листе

| Критерий | Реализация
|----------|------------
| NFR ≥ 8 с критериями | 10 NFR требований с метриками
| 3-4 DFD с границами доверия | 4 DFD диаграммы
| STRIDE ≥ 8 угроз | 10 угроз, все категории покрыты
| Меры с трассировкой | Полная трассировка угроз → риски → NFR → контрмеры
| Приоритизация/оформление | Количественная приоритизация рисков, структурированная документация


| Критерий | Реализация |
|----------|------------|
| Misuse/Abuse Cases | 6 детально проработанных случаев с анализом угроз и контрмер |
| Качественная аргументация рисков | Количественная оценка рисков, анализ альтернатив в ADR, обоснование стратегий |

Все требования базового чек-листа и дополнительные критерии для оценки 9-10 баллов выполнены.

---

### 4 DFD диаграммы с границами доверия

Создано четыре диаграммы потоков данных, каждая с границами доверия:
- DFD.md — общий контекст системы, 4 потока данных
- DFD_AUTH.md — аутентификация и авторизация, 9 потоков данных
- DFD_ERRORS.md — обработка ошибок, 11 потоков данных
- DFD_PROCESS.md — бизнес-логика CRUD операций, 18 потоков данных


Создан документ `docs/threat-model/MISUSE_CASES.md` с шестью детально проработанными случаями (MC-01 до MC-06). Каждый случай содержит тип (Misuse или Abuse), приоритет и категорию STRIDE, детальное описание сценария, шаги атаки или злоупотребления, вектор атаки, описание текущих контрмер и их недостатков, рекомендуемые дополнительные меры, полную трассировку к угрозам, рискам и NFR требованиям.


Риски детально обоснованы в `RISKS.md` с количественной оценкой (Likelihood × Impact), определены стратегии управления рисками. ADR документы содержат анализ альтернативных решений, описание последствий и мер смягчения. Все архитектурные решения связаны с моделью угроз и NFR требованиями.

---


### Список реализованных NFR требований

1. NFR-01: Формат ошибок и маскирование PII
2. NFR-02: Аутентификация (минимум)
3. NFR-03: Rate limiting
4. NFR-04: Зависимости без High/Critical
5. NFR-05: Секреты не в коде
6. NFR-06: Производительность /wishes (p95)
7. NFR-07: Логи без PII
8. NFR-08: Миграции/схема согласованы
9. NFR-09: Бэкапы (демо-политика)
10. NFR-10: Корреляция ошибок

### Список выявленных угроз STRIDE

1. S: Spoofing (подмена пользователя) — R1
2. I: Information disclosure — R2
3. D: Denial of Service — R3
4. R: Repudiation — R4
5. T: Tampering (ввод невалидных данных) — R5
6. E: Elevation of Privilege — R6
7. I: Info disclosure через БД — R7
8. T: Tampering (инъекции) — R8
9. I: Verbose errors/stack traces — R9
10. I/T: Утечка секретов в код — R10
