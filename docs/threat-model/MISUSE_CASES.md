# Misuse Cases и Abuse Cases

Документ описывает сценарии злоупотребления и неправильного использования Wishlist API, а также меры противодействия.

## Определения

- **Misuse Case**: Сценарий неправильного использования системы законными пользователями
- **Abuse Case**: Сценарий злонамеренного использования системы с целью компрометации

---

## MC-01: Обход Rate Limiting через распределение запросов

### Описание
**Тип**: Abuse Case
**Приоритет**: Высокий
**Категория**: Denial of Service (DoS)

### Сценарий
Злоумышленник пытается обойти rate limiting (60 req/min) путем распределения запросов между несколькими IP-адресами или использования прокси/VPN.

**Шаги атаки:**
1. Злоумышленник использует ботнет или VPN для получения множества IP-адресов
2. Распределяет запросы между IP-адресами так, чтобы каждый IP делал < 60 req/min
3. Совокупно превышает допустимую нагрузку на сервер
4. Может привести к перегрузке сервера или исчерпанию ресурсов БД

### Вектор атаки
```
Attacker → VPN/Proxy Network → Multiple IPs → API Server
```

### Текущие контрмеры
- ✅ Rate limiting по IP адресу (60 req/min)
- ✅ Sliding window алгоритм
- ✅ HTTP 429 при превышении

### Недостатки текущей защиты
- Rate limiting только по IP (легко обойти через прокси)
- Нет агрегированного лимита на уровне приложения
- Отсутствие механизма "slow down" для подозрительных IP

### Рекомендуемые дополнительные меры
1. Агрегированный rate limiting на уровне JWT токена (если доступен)
2. Геоблокировка подозрительных регионов (опционально)
3. Мониторинг паттернов распределенных атак
4. CAPTCHA для подозрительной активности
5. Whitelist/Blacklist IP адресов

### Связь с угрозами
- **STRIDE**: D (Denial of Service) → R3
- **NFR-03**: Rate limiting
- **DFD**: F2 (Edge) - Rate Limit Check

---

## MC-02: Подделка JWT токена

### Описание
**Тип**: Abuse Case
**Приоритет**: Критический
**Категория**: Spoofing, Elevation of Privilege

### Сценарий
Злоумышленник пытается подделать JWT токен для получения несанкционированного доступа к мутирующим операциям API.

**Варианты атаки:**

#### Вариант 2.1: Подбор секрета
1. Злоумышленник пытается угадать слабый JWT_SECRET
2. Использует словарь распространенных секретов ("secret", "dev", "12345")
3. При успехе может генерировать валидные токены

#### Вариант 2.2: Алгоритм "none"
1. Изменяет заголовок токена на `{"alg": "none"}`
2. Удаляет подпись или использует пустую подпись
3. Если валидатор не проверяет алгоритм строго, токен может быть принят

#### Вариант 2.3: Использование истекшего токена
1. Получает токен другого пользователя (через перехват)
2. Пытается использовать его после истечения срока действия
3. Если проверка exp отсутствует, токен может быть принят

### Вектор атаки
```
Attacker → Modified JWT Token → API → Auth Middleware → Bypass?
```

### Текущие контрмеры
- ✅ Проверка подписи JWT (HS256)
- ✅ Указание алгоритма в decode: `algorithms=["HS256"]`
- ✅ Секрет хранится в переменной окружения

### Недостатки текущей защиты
- Отсутствие явной проверки exp (expiration) токена
- Нет проверки iat (issued at) для предотвращения повторного использования
- Секрет "dev" по умолчанию в коде (только для разработки)
- Отсутствие механизма отзыва токенов

### Рекомендуемые дополнительные меры
1. Обязательная проверка exp и iat в токене
2. Использование сильного случайного секрета в продакшене
3. Регулярная ротация секрета
4. Механизм blacklist для отозванных токенов (через Redis)
5. Логирование неудачных попыток аутентификации
6. Rate limiting на неудачные попытки аутентификации

### Связь с угрозами
- **STRIDE**: S (Spoofing) → R1, E (Elevation of Privilege) → R6
- **NFR-02**: JWT аутентификация
- **DFD_AUTH**: F3, F4 (JWT Validation)

---

## MC-03: Инъекция через параметры запроса

### Описание
**Тип**: Abuse Case
**Приоритет**: Высокий
**Категория**: Tampering

### Сценарий
Злоумышленник пытается выполнить SQL-инъекцию или NoSQL-инъекцию через параметры запроса GET /wishes.

**Варианты атаки:**

#### Вариант 3.1: SQL-инъекция через параметр `q`
```
GET /wishes?q=' OR '1'='1' --
GET /wishes?q='; DROP TABLE wishes; --
```

#### Вариант 3.2: NoSQL-инъекция через параметр `price_lte`
```
GET /wishes?price_lte[$ne]=0
GET /wishes?price_lte[$gt]=0
```

#### Вариант 3.3: Path Traversal (если бы использовались файлы)
```
GET /wishes?file=../../../etc/passwd
```

### Вектор атаки
```
Attacker → Malicious Query Params → API → Repository → DB
```

### Текущие контрмеры
- ✅ ORM (SQLAlchemy) с параметризованными запросами
- ✅ Pydantic валидация типов параметров
- ✅ Валидация через Query параметры FastAPI

### Проверка защиты

**Пример защищенного кода:**
```python
@router.get("", response_model=List[WishOut])
def list_wishes(
    q: Optional[str] = Query(None),
    price_lte: Optional[int] = Query(None, ge=0),
    db: Session = Depends(get_db),
):
    repo = WishRepository(db)
    return list(repo.list(q=q, purchased=purchased, price_lte=price_lte))
```

SQLAlchemy ORM автоматически использует параметризованные запросы, что защищает от SQL-инъекций.

### Недостатки текущей защиты
- Если в будущем добавится прямой SQL, могут появиться уязвимости
- Недостаточная санитизация строковых параметров (спецсимволы)

### Рекомендуемые дополнительные меры
1. Регулярный код-ревью для проверки использования ORM
2. Запрет прямых SQL запросов без параметризации
3. Санитизация строковых параметров (удаление спецсимволов)
4. Лимит длины параметров запроса
5. Тесты на инъекции в CI/CD

### Связь с угрозами
- **STRIDE**: T (Tampering) → R5, R8
- **NFR-01**: Валидация данных
- **DFD_PROCESS**: F6, F7, F10, F11 (Query Processing)

---

## MC-04: Перебор эндпоинтов для поиска уязвимостей

### Описание
**Тип**: Abuse Case
**Приоритет**: Средний
**Категория**: Information Disclosure

### Сценарий
Злоумышленник систематически перебирает эндпоинты и параметры для поиска скрытых функциональностей, уязвимостей или утечек информации.

**Варианты атаки:**

#### Вариант 4.1: Перебор ID ресурсов
```
GET /wishes/1
GET /wishes/2
GET /wishes/999
GET /wishes/0
GET /wishes/-1
GET /wishes/admin
```

#### Вариант 4.2: Перебор методов HTTP
```
OPTIONS /wishes
HEAD /wishes
PUT /wishes
TRACE /wishes
```

#### Вариант 4.3: Перебор путей
```
GET /api/wishes
GET /v1/wishes
GET /admin
GET /.env
GET /config
```

### Вектор атаки
```
Attacker → Automated Scanner → API → Enumeration of Endpoints
```
### Рекомендуемые дополнительные меры
1. Лимит на количество 404 ошибок с одного IP
2. Использование нестандартных путей (не раскрывать структуру API)
3. WAF (Web Application Firewall) для блокировки известных паттернов
4. Логирование подозрительной активности
5. Алертинг при аномальных паттернах запросов

### Связь с угрозами
- **STRIDE**: I (Information Disclosure) → R2
- **NFR-01**: Формат ошибок без утечек
- **DFD_ERRORS**: F6, F7 (Error Sanitization)

---

## MC-05: Неправильное использование API законным пользователем

### Описание
**Тип**: Misuse Case
**Приоритет**: Низкий
**Категория**: User Error

### Сценарий
Законный пользователь неправильно использует API из-за недопонимания документации или ошибок в клиентском приложении.

**Примеры:**

#### Вариант 5.1: Создание желаний с невалидными данными
```
POST /wishes
{
  "title": "",  // пустой title
  "price_estimate": -100  // отрицательная цена
}
```

#### Вариант 5.2: Частые запросы из-за багов в клиенте
- Клиент делает запросы в цикле без задержки
- Приводит к превышению rate limit для легитимного пользователя

#### Вариант 5.3: Попытка обновить несуществующий ресурс
```
PATCH /wishes/999999
{
  "title": "New Title"
}
```

### Вектор проблемы
```
Legitimate User → Client App Bug → API → Rate Limit / Validation Error
```

### Текущие контрмеры
- ✅ Валидация данных (Pydantic)
- ✅ Четкие сообщения об ошибках (RFC 7807)
- ✅ Rate limiting защищает от перегрузки

### Недостатки
- Сообщения об ошибках могут быть недостаточно понятными для пользователей
- Нет документации по правильному использованию API

### Рекомендуемые меры
1. Улучшение сообщений об ошибках валидации
2. API документация (Swagger/OpenAPI) с примерами
3. Версионирование API для обратной совместимости
4. Retry-логика с exponential backoff в клиентах

### Связь с угрозами
- **STRIDE**: T (Tampering) → R5 (непреднамеренное)
- **NFR-01**: Валидация и формат ошибок
- **DFD_PROCESS**: F2, F8, F9 (Validation)

---

## MC-06: Эскалация привилегий через манипуляцию ID

### Описание
**Тип**: Abuse Case
**Приоритет**: Высокий
**Категория**: Elevation of Privilege

### Сценарий
**Текущее состояние**: Система не проверяет ownership желаний (wishes).

Злоумышленник, имеющий валидный JWT токен, может изменять/удалять желания других пользователей, угадывая или перебирая ID.

**Шаги атаки:**
1. Злоумышленник создает желание и получает ID (например, 42)
2. Пытается изменить желание с другим ID (например, 43)
3. Если проверка ownership отсутствует, операция может быть успешной
4. Может удалить или изменить желания других пользователей

**Примеры запросов:**
```
# Создает свое желание
POST /wishes {"title": "My Wish"}
Response: {"id": 42, ...}

# Пытается изменить чужое желание
PATCH /wishes/43 {"title": "Hacked!"}
# Может быть успешно, если нет проверки ownership
```

### Вектор атаки
```
Attacker (Valid JWT) → Manipulate Resource ID → API → Unauthorized Access
```

### Текущие контрмеры
- ✅ JWT проверка для мутаций (защита от неавторизованных)
- ⚠️ **Отсутствует**: Проверка ownership ресурса

### Недостатки текущей защиты
- Нет связи между JWT токеном и владельцем ресурса
- Нет проверки, что пользователь может изменять только свои желания
- В будущем может привести к нарушению конфиденциальности данных

### Рекомендуемые меры
1. Добавить user_id в JWT payload
2. Добавить user_id в модель Wish
3. Проверять ownership перед мутациями:
   ```python
   wish = repo.get(wish_id)
   if wish.user_id != current_user_id:
       raise HTTPException(403, "Forbidden")
   ```
4. Тесты на попытки доступа к чужим ресурсам
5. Логирование попыток несанкционированного доступа

### Связь с угрозами
- **STRIDE**: E (Elevation of Privilege) → R6
- **RISKS.md**: R6 - "Эскалация привилегий (чужие wishes)"
- **DFD_PROCESS**: F5, F8 (Authorization Check)

---

## Резюме Misuse/Abuse Cases

| ID | Название | Тип | Приоритет | Категория STRIDE | Риск | Статус защиты |
|----|----------|-----|-----------|------------------|------|---------------|
| MC-01 | Обход Rate Limiting | Abuse | Высокий | D (DoS) | R3 | Частично |
| MC-02 | Подделка JWT | Abuse | Критический | S, E | R1, R6 | Частично |
| MC-03 | Инъекция через параметры | Abuse | Высокий | T | R5, R8 | Хорошо |
| MC-04 | Перебор эндпоинтов | Abuse | Средний | I | R2 | Частично |
| MC-05 | Неправильное использование | Misuse | Низкий | T | R5 | Хорошо |
| MC-06 | Эскалация привилегий | Abuse | Высокий | E | R6 | Требует доработки |

## Общие рекомендации

### Приоритетные меры
1. **Реализовать проверку ownership** (MC-06) - критично для безопасности данных
2. **Усилить проверку JWT** (MC-02) - добавить проверку exp/iat
3. **Улучшить rate limiting** (MC-01) - агрегированный лимит на уровень приложения

### Мониторинг и обнаружение
- Логирование всех подозрительных активностей
- Алертинг при аномальных паттернах (перебор, инъекции)
- Метрики по failed authentication attempts
- Мониторинг rate limit превышений

### Тестирование
- Автоматизированные тесты на misuse cases
- Penetration testing для abuse cases
- Security code review для проверки защиты

## Связь с документацией

- **STRIDE.md**: Все угрозы из misuse cases
- **RISKS.md**: Соответствующие риски (R1, R2, R3, R5, R6, R8)
- **NFR**: Требования безопасности (NFR-01, NFR-02, NFR-03)
- **DFD**: Потоки данных, где возникают угрозы
- **ADR**: Архитектурные решения для противодействия

---

*Документ обновляется по мере выявления новых векторов атак и улучшения системы безопасности*
